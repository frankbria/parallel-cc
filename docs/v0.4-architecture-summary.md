# v0.4 Merge Detection - Quick Reference

## TL;DR Architecture

### Key Design Decision
**MCP cannot push notifications** (request/response protocol only). Solution: Use existing PostToolUse heartbeat hook to deliver notifications.

### Core Components

```
┌─────────────────────────────────────────────────────┐
│ Background Process                                  │
│ parallel-cc watch-merges (30s polling)              │
│   ↓                                                 │
│ Detects merged branches                             │
│   ↓                                                 │
│ Writes to SQLite (merge_events, notifications)      │
└─────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│ PostToolUse Hook (after every Claude tool)          │
│ parallel-cc-heartbeat.sh                            │
│   ↓                                                 │
│ Checks for unacknowledged notifications             │
│   ↓                                                 │
│ Outputs warnings to stdout                          │
└─────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│ Claude Code Session                                 │
│ Sees warnings, suggests rebase                      │
└─────────────────────────────────────────────────────┘
```

## New Database Tables

| Table | Purpose | Key Columns |
|-------|---------|-------------|
| `merge_events` | Detected merges | `repo_path`, `branch`, `merged_at`, `merge_commit_sha` |
| `branch_subscriptions` | What branches sessions watch | `session_id`, `branch` (CASCADE on session delete) |
| `merge_notifications` | Delivery tracking | `merge_event_id`, `session_id`, `acknowledged` |

## New MCP Tools

| Tool | Purpose |
|------|---------|
| `notify_when_merged` (enhanced) | Subscribe to branch merge notifications |
| `get_merge_events` (NEW) | Query merge history for repo |
| `acknowledge_merge` (NEW) | Mark notification as read |
| `get_merge_status` (NEW) | Real-time check if branch is merged |

## New CLI Commands

```bash
# Start merge detector daemon
parallel-cc watch-merges [--interval 30] [--target main]

# Check merge history
parallel-cc merge-status [--since "2025-12-01"] [--json]

# Check notifications (used by hook)
parallel-cc check-notifications [--session-id <id>]
```

## New TypeScript Modules

| File | Purpose | Lines | Tests |
|------|---------|-------|-------|
| `src/merge-detector.ts` | Git merge detection logic | ~300 | 50+ |
| `src/merge-db.ts` | Database operations | ~200 | 40+ |
| `src/mcp/tools.ts` (additions) | MCP tool implementations | ~150 | 30+ |
| `src/mcp/schemas.ts` (additions) | Zod schemas | ~100 | - |

## Git Detection Algorithm

```bash
# Primary check: Is branch merged?
git merge-base --is-ancestor <branch> origin/main
# Exit 0 = merged, 1 = not merged

# Get merge metadata
git log --merges --first-parent origin/main \
  --pretty=format:'%H|%ct' | grep "Merge.*<branch>"
```

**Handles:**
- Standard merge commits ✅
- Fast-forward merges ✅
- Squash merges (with limitations) ⚠️
  - Detection works (ancestry check)
  - May not find exact merge commit
  - v0.5 will add GitHub API for accurate metadata

## User Workflows

### Workflow 1: Basic Subscription
```bash
# Terminal 1: Start detector
$ parallel-cc watch-merges

# Terminal 2: Claude session
$ claude
> notify_when_merged({branch: "feature-auth"})
✅ Subscribed to merge notifications

# Later (after feature-auth merges):
> [any tool execution]
⚠️  Branch 'feature-auth' was merged to main 5 minutes ago
```

### Workflow 2: Manual Check
```typescript
// Claude calls MCP tool
get_merge_events({unacknowledged_only: true})
// Returns: [{branch: "feature-x", mergedAt: "...", acknowledged: false}]

acknowledge_merge({merge_event_id: "uuid-123"})
// Marks as read, won't notify again
```

### Workflow 3: Real-Time Status
```typescript
get_merge_status({branch: "feature-payments"})
// Returns: {
//   isMerged: false,
//   needsRebase: true,
//   behindBy: 5,
//   divergedBy: 3
// }
```

## Integration Points

### SessionDB Extension
```typescript
// Shares SQLite connection
class SessionDB {
  getMergeDB(): MergeDB {
    return new MergeDB(this.db);
  }
}
```

### Coordinator Extension
```typescript
class Coordinator {
  getBranchesToWatch(repoPath: string): string[] {
    // Returns: worktree branches + subscribed branches
  }
}
```

### Heartbeat Hook Enhancement
```bash
#!/bin/bash
parallel-cc heartbeat --pid $$
parallel-cc check-notifications  # NEW in v0.4
```

## Edge Cases Handled

| Scenario | Solution |
|----------|----------|
| Branch deleted before detection | `git fetch --prune`, check reflog |
| Multiple repos | Loop over all repo_paths from sessions |
| Session ends before notification | `CASCADE` cleanup (notification deleted) |
| Detector not running | `notify_when_merged` warns user |
| Network errors | Log and continue, retry next interval |
| Race conditions | SQLite transactions + `ON CONFLICT` |

## Performance

- **Polling overhead:** <1s per repo per 30s interval
- **Database queries:** <1ms (indexed)
- **Memory:** ~5MB for detector, ~50KB per 1000 events
- **Scalability:** Linear with repos × branches

## Testing Strategy

- **Unit tests:** 120+ tests across 3 new test files
- **Integration tests:** End-to-end workflow validation
- **Coverage target:** >85% on all new modules
- **Manual testing:** Real git repos, GitHub squash merges

## Migration from v0.3

1. ✅ Auto-migration on first run (schema changes)
2. ✅ No breaking changes
3. ✅ Opt-in via `parallel-cc watch-merges`
4. ✅ Backward compatible

## Success Criteria

- [x] Architecture designed
- [ ] Reliable merge detection (95%+ accuracy)
- [ ] Notifications appear in Claude sessions
- [ ] >85% test coverage
- [ ] Zero breaking changes
- [ ] Performance <5% overhead

## Next Steps

1. Implement `src/merge-detector.ts`
2. Implement `src/merge-db.ts`
3. Add new MCP tools
4. Update CLI commands
5. Write tests (TDD preferred)
6. Manual validation
7. Documentation updates

## Future Enhancements

- **v0.5:** File-level conflict detection
- **v0.6:** GitHub API integration for squash merges
- **v0.7:** Automated rebase assistance

---

**Quick Links:**
- [Full Architecture Doc](./v0.4-merge-detection-architecture.md)
- [ROADMAP.md v0.4 section](../ROADMAP.md#v04---branch-merge-detection--rebase-assistance)
- [v0.3 Implementation Plan](./v0.3-implementation-plan.md)

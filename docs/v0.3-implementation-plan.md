# v0.3 Implementation Plan: MCP Server for Status Queries

## Overview

This document details the implementation plan for parallel-cc v0.3, which adds an MCP (Model Context Protocol) server enabling Claude Code to query session status mid-conversation.

**Goals:**
1. Implement MCP server with 3 tools
2. Achieve >85% test coverage across all source files
3. Integration with existing CLI and database infrastructure

**Estimated Complexity:** Moderate (new infrastructure + testing debt)

---

## Current State Analysis

### Codebase Metrics (v0.2.4)

| File | Lines | Coverage | Notes |
|------|-------|----------|-------|
| coordinator.ts | 261 | 0% | Core session logic - needs tests |
| db.ts | 183 | 0% | SQLite operations - needs tests |
| gtr.ts | 220 | 0% | Worktree wrapper - needs tests |
| hooks-installer.ts | ~700 | 86% | Well tested |
| logger.ts | 76 | 0% | Simple utility - low priority |
| types.ts | 85 | 0% | Type definitions only |
| cli.ts | ~200 | 0% | CLI glue code |
| **Overall** | - | **38%** | Target: >85% |

### Existing Infrastructure

- **Database:** SQLite via better-sqlite3, already supports queries needed for MCP tools
- **Coordinator:** Has `status()` method that returns session info - can be reused
- **Types:** `SessionInfo`, `StatusResult` already define return structures

---

## Phase 1: Testing Foundation (Priority: High)

**Rationale:** Establish test coverage before adding new features to prevent regressions.

### 1.1 Database Tests (`tests/db.test.ts`)

Test coverage for `SessionDB` class:

```typescript
// Test categories needed:
- Constructor: path resolution, directory creation, WAL mode
- createSession: success, duplicate handling
- getSessionsByRepo: empty, single, multiple sessions
- getSessionByPid: found, not found
- getSessionById: found, not found
- getAllSessions: empty, populated
- updateHeartbeat: success, non-existent session
- updateHeartbeatByPid: success, non-existent
- deleteSession: success, non-existent
- getStaleSessions: threshold logic, datetime handling
- transaction: atomicity, rollback on error
- close: cleanup
```

**Mocking Strategy:**
- Use temp directories for test databases
- Clean up after each test
- No external mocks needed (SQLite is fast)

### 1.2 Coordinator Tests (`tests/coordinator.test.ts`)

Test coverage for `Coordinator` class:

```typescript
// Test categories needed:
- Constructor: config merging, default values
- register:
  - First session (main repo)
  - Parallel session (creates worktree)
  - Re-registration (same PID)
  - Invalid inputs (bad path, bad PID)
  - Race condition handling (transaction)
- heartbeat: success, non-existent PID
- release:
  - Main repo session (no cleanup)
  - Worktree session (cleanup)
  - Non-existent session
- status:
  - Specific repo
  - All repos
  - Process alive detection
- cleanup:
  - Stale sessions removed
  - Dead process detection
  - Worktree cleanup
```

**Mocking Strategy:**
- Mock `GtrWrapper` to avoid real git operations
- Use temp database paths
- Mock `process.kill` for alive detection tests

### 1.3 GtrWrapper Tests (`tests/gtr.test.ts`)

Test coverage for `GtrWrapper` class:

```typescript
// Test categories needed:
- detectGtrCommand: v1.x detection, v2.x detection, not found
- isAvailable: true when found, false when missing
- createWorktree: success, failure
- getWorktreePath: success, failure
- removeWorktree: success with/without branch delete
- listWorktrees: parse porcelain output, fallback to git
- generateWorktreeName: format, uniqueness
```

**Mocking Strategy:**
- Mock `execSync` to simulate gtr/git responses
- No real git operations in unit tests
- Test both v1.x and v2.x command formats

### 1.4 Coverage Target Validation

After Phase 1, run coverage report:
```bash
npm test -- --coverage --run
```

**Target:** >85% overall before proceeding to Phase 2

---

## Phase 2: MCP Server Infrastructure

### 2.1 Dependencies

Add to `package.json`:
```json
{
  "dependencies": {
    "@modelcontextprotocol/sdk": "^1.0.0",
    "zod": "^3.23.0"
  }
}
```

### 2.2 New File Structure

```
src/
├── mcp/
│   ├── index.ts          # MCP server setup and tool registration
│   ├── tools.ts          # Tool implementations
│   └── schemas.ts        # Zod schemas for inputs/outputs
├── coordinator.ts        # (existing)
├── db.ts                 # (existing)
└── ...
```

### 2.3 MCP Server Module (`src/mcp/index.ts`)

```typescript
import { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';
import { registerTools } from './tools.js';

export function createMcpServer(): McpServer {
  const server = new McpServer({
    name: 'parallel-cc',
    version: '0.3.0'
  });

  registerTools(server);
  return server;
}

export async function startMcpServer(): Promise<void> {
  const server = createMcpServer();
  const transport = new StdioServerTransport();
  await server.connect(transport);
}
```

### 2.4 Transport Choice: stdio

**Decision:** Use `StdioServerTransport` (not HTTP)

**Rationale:**
- Claude Code spawns MCP servers as child processes
- stdio is the standard for local MCP servers
- No port management needed
- Simpler deployment

**Configuration in Claude Code:**
```json
{
  "mcpServers": {
    "parallel-cc": {
      "command": "parallel-cc",
      "args": ["mcp-serve"]
    }
  }
}
```

---

## Phase 3: MCP Tool Implementation

### 3.1 Tool: `get_parallel_status`

**Purpose:** Returns info about all active sessions in the current repo.

**Input Schema:**
```typescript
{
  repo_path?: string  // Optional, defaults to cwd
}
```

**Output Schema:**
```typescript
{
  sessions: Array<{
    pid: number,
    worktreePath: string,
    worktreeName: string | null,
    isMainRepo: boolean,
    durationMinutes: number,
    isAlive: boolean
  }>,
  totalSessions: number
}
```

**Implementation:**
```typescript
server.registerTool(
  'get_parallel_status',
  {
    title: 'Get Parallel Status',
    description: 'Get status of all parallel Claude Code sessions in this repo',
    inputSchema: {
      repo_path: z.string().optional().describe('Repository path (defaults to cwd)')
    },
    outputSchema: GetParallelStatusOutputSchema
  },
  async ({ repo_path }) => {
    const coordinator = new Coordinator();
    try {
      const repoPath = repo_path || process.cwd();
      const result = coordinator.status(repoPath);

      const output = {
        sessions: result.sessions.map(s => ({
          pid: s.pid,
          worktreePath: s.worktreePath,
          worktreeName: s.worktreeName,
          isMainRepo: s.isMainRepo,
          durationMinutes: s.durationMinutes,
          isAlive: s.isAlive
        })),
        totalSessions: result.totalSessions
      };

      return {
        content: [{ type: 'text', text: JSON.stringify(output, null, 2) }],
        structuredContent: output
      };
    } finally {
      coordinator.close();
    }
  }
);
```

### 3.2 Tool: `get_my_session`

**Purpose:** Returns info about the current session.

**Input Schema:**
```typescript
{}  // No inputs - uses PARALLEL_CC_PID env var
```

**Output Schema:**
```typescript
{
  sessionId: string,
  worktreePath: string,
  worktreeName: string | null,
  isMainRepo: boolean,
  startedAt: string,
  parallelSessions: number
}
```

**Implementation Notes:**
- Requires wrapper script to set `PARALLEL_CC_PID` environment variable
- Falls back gracefully if not in a managed session

**Wrapper Script Enhancement:**
```bash
# In claude-parallel.sh, add before exec:
export PARALLEL_CC_PID=$$
```

### 3.3 Tool: `notify_when_merged`

**Purpose:** Subscribe to notifications when a branch is merged to main.

**Input Schema:**
```typescript
{
  branch: string  // Branch name to watch
}
```

**Output Schema:**
```typescript
{
  subscribed: boolean,
  message: string
}
```

**Implementation Decision: Polling vs Push**

**Option A: Polling (Recommended for v0.3)**
- Store subscription in database
- Tool returns immediately with confirmation
- Claude can call `check_merge_status` periodically
- Simpler implementation, no notification system needed

**Option B: Push Notifications (Defer to v0.4)**
- Requires MCP notification mechanism
- More complex state management
- Better UX but higher implementation cost

**v0.3 Approach:**
```typescript
// Store subscription
server.registerTool(
  'notify_when_merged',
  {
    title: 'Watch Branch for Merge',
    description: 'Subscribe to be notified when a branch is merged',
    inputSchema: {
      branch: z.string().describe('Branch name to watch')
    },
    outputSchema: {
      subscribed: z.boolean(),
      message: z.string()
    }
  },
  async ({ branch }) => {
    // For v0.3: Just acknowledge the subscription
    // Actual merge detection deferred to v0.4
    const output = {
      subscribed: true,
      message: `Watching branch '${branch}' for merge. Use 'check_merge_status' to check.`
    };
    return {
      content: [{ type: 'text', text: JSON.stringify(output) }],
      structuredContent: output
    };
  }
);
```

**Note:** Full `notify_when_merged` implementation with actual git polling is scoped for v0.4 (Branch Merge Detection). v0.3 provides the API surface.

---

## Phase 4: CLI Integration

### 4.1 New CLI Command: `mcp-serve`

Add to `cli.ts`:
```typescript
program
  .command('mcp-serve')
  .description('Start MCP server for Claude Code integration')
  .action(async () => {
    await startMcpServer();
  });
```

### 4.2 Doctor Command Enhancement

Update `doctor` to check MCP readiness:
```typescript
// In doctor command:
checks.push({
  name: 'MCP SDK',
  status: checkMcpSdkAvailable()
});
```

### 4.3 Install Command Enhancement

Add MCP server configuration option:
```bash
parallel-cc install --mcp
# Adds to ~/.claude/settings.json:
# {
#   "mcpServers": {
#     "parallel-cc": {
#       "command": "parallel-cc",
#       "args": ["mcp-serve"]
#     }
#   }
# }
```

---

## Phase 5: Integration Testing

### 5.1 MCP Tool Tests (`tests/mcp.test.ts`)

```typescript
// Test categories:
- get_parallel_status: empty, with sessions, repo filtering
- get_my_session: with env var, without env var
- notify_when_merged: subscription acknowledgment
- Error handling: invalid inputs, database errors
```

### 5.2 End-to-End Test Scenarios

Manual testing checklist:
- [ ] Start `parallel-cc mcp-serve` in one terminal
- [ ] Use MCP client to call each tool
- [ ] Verify JSON responses match schemas
- [ ] Test with real parallel sessions running

---

## Implementation Sequence

### Sprint 1: Testing Foundation (Estimated: 2-3 sessions)

1. Create `tests/db.test.ts` with full SessionDB coverage
2. Create `tests/coordinator.test.ts` with mocked gtr
3. Create `tests/gtr.test.ts` with mocked execSync
4. Validate >85% coverage achieved

### Sprint 2: MCP Infrastructure (Estimated: 1-2 sessions)

1. Add dependencies (`@modelcontextprotocol/sdk`, `zod`)
2. Create `src/mcp/schemas.ts` with Zod schemas
3. Create `src/mcp/index.ts` with server setup
4. Add `mcp-serve` CLI command

### Sprint 3: Tool Implementation (Estimated: 2 sessions)

1. Implement `get_parallel_status` tool
2. Implement `get_my_session` tool
3. Implement `notify_when_merged` stub
4. Update wrapper script with PARALLEL_CC_PID

### Sprint 4: Polish & Integration (Estimated: 1-2 sessions)

1. Create `tests/mcp.test.ts`
2. Update `doctor` command
3. Add `install --mcp` option
4. Manual E2E testing
5. Update CLAUDE.md and ROADMAP.md

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| MCP SDK API changes | Low | Medium | Pin version, monitor changelog |
| Testing coordinator requires git ops | Medium | Low | Mock GtrWrapper thoroughly |
| stdio transport compatibility | Low | High | Test early with real Claude Code |
| Coverage target unachievable | Low | Medium | Exclude trivial files (logger, types) |

---

## Success Criteria

- [ ] All 3 MCP tools implemented and functional
- [ ] Test coverage >85% (excluding types.ts)
- [ ] `parallel-cc mcp-serve` starts without errors
- [ ] Claude Code can query session status via MCP
- [ ] No regressions in existing CLI functionality
- [ ] Documentation updated (CLAUDE.md, ROADMAP.md)

---

## Open Questions

1. **Environment variable naming:** `PARALLEL_CC_PID` vs `PARALLEL_CC_SESSION_ID`?
   - Recommendation: Use PID for simplicity, session ID for robustness

2. **MCP server auto-start:** Should `claude-parallel` wrapper also start MCP server?
   - Recommendation: No, keep them separate. MCP server is configured in Claude settings.

3. **Database sharing:** MCP server and CLI share same SQLite DB - any locking concerns?
   - Already using WAL mode with busy_timeout - should be fine.

---

## References

- [MCP TypeScript SDK](https://github.com/modelcontextprotocol/typescript-sdk)
- [Zod Documentation](https://zod.dev/)
- [parallel-cc ROADMAP](../ROADMAP.md)
- [better-sqlite3 Transactions](https://github.com/WiseLibs/better-sqlite3/blob/master/docs/api.md#transactionfunction---function)
